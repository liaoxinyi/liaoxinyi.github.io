---
layout:     post
title:      "聊一聊分布式-01"
subtitle:   "分布式事务"
date:  2021-06-01
author:     "ThreeJin"
header-mask: 0.5
catalog: true
header-img: "https://gitee.com/liaoxinyiqiqi/my-blog-images/raw/master/img/threadpool.jpg"
tags:
    - Java
    - 分布式
    - Transaction
---
> 来源于公众号上的各位大佬文章（三太子敖丙等）总结

### 前言
这篇文章的绝大部分内容都是来自于网络上的各位前辈的资料以及自己的一些感悟。老实说，涉及到分布式事务的东西还真的没有实操过。在物联网之中，尤其是在我这个小组，分布式会遇到，但是真正涉及到分布式事务的情况却少之又少。或者说，是我在开发的时候，压根儿就没有想到过还有分布式事务这个东西。说白了，就是并发量不到一定的级别，其实是很难出现分布式事务的问题的。
### 什么是分布式事务？
毋庸置疑，本地的事务一般是交给了数据库来完成，很省事儿，但是一旦整个应用拆分且分布式部署起来后，各自本地的事务就没法再让数据库来保证了。以互联网中的一个电商例子说明：  
一般来说，下单和减库存往往会是在不同的服务之中。如果没有分布式事务的保证，一旦出现问题（网络波动，服务器宕机等）会导致下单了但是没减库存或者减库存了但下单失败  

**这个时候，需要在设计和开发的时候保证，下单与减库存的操作要是原子的操作，也就是这两个服务的这两个操作要在同一个事务之中，要么都成功，要么都失败**
### 策略1：2PC
##### 是什么？
2PC（`Two-phase commit protocol`），中文叫二阶段提交  
**二阶段提交是一种强一致性设计**，2PC 引入一个`事务协调者`的角色来协调管理各`参与者`（也可称之为各本地资源）的提交和回滚，二阶段分别指的是准备（投票）和提交两个阶段

- **准备阶段**  
    - 协调者会给各参与者发送准备命令，告诉这些参与者快赶紧除了提交事务之外啥事都做完并及时反馈  
    - **协调者会同步等待所有资源的响应**，收到响应后才能进入第二阶段  
    - 此阶段的协调者**有超时机制**：假设因为网络原因没有收到某参与者的响应或某参与者挂了，那么超时后就会判断事务失败，向所有参与者发送回滚命令  
- **提交阶段**  
    - 如果准备阶段中所有参与者都返回了成功，那么协调者则向所有参与者发送提交事务命令，然后等待所有事务都提交成功之后，返回事务执行成功  
    - 如果准备阶段中有一个参与者返回失败，那么协调者就会向所有参与者发送回滚事务的请求，即分布式事务执行失败
    
##### 提交阶段失败了怎么办？

- **第二阶段执行的是回滚事务操作**  
不断重试，直到所有参与者都回滚了，不然那些在第一阶段准备成功的参与者会因为在等待协调者的提交命令而一直阻塞着  
- **第二阶段执行的是提交事务操作**  
不断重试，因为有可能一些参与者的事务已经提交成功了，这个时候只有一条路，就是头铁往前冲，不断的重试，直到提交成功，到最后真的不行只能人工介入处理

##### 协调者故障了怎么办？

- **发送准备命令之前**挂了，还行等于事务还没开始，问题不大  
- **发送准备命令之后**挂了，这就不太行了，因为可能有些参与者都已经准备好且处于事务资源锁定的状态了。此时不仅事务执行不下去，还会因为锁定了一些公共资源而阻塞系统其它操作  
- **发送回滚事务命令之前**挂了，那么事务也是执行不下去，且在第一阶段那些准备成功参与者都阻塞着  
- **发送回滚事务命令之后**挂了，这个还行，至少命令发出去了，很大的概率都会回滚成功，资源都会释放。但是如果出现网络分区问题，某些参与者将因为收不到命令而阻塞着  
- **发送提交事务命令之前**挂了，这是最惨的，此时所有资源都阻塞着  
- **发送提交事务命令之后**挂了，这个还行，也是至少命令发出去了，很大概率都会提交成功，然后释放资源，但是如果出现网络分区问题某些参与者将因为收不到命令而阻塞着  

所以，有必要保证协调者的高可用，这里可以采用**集群+故障选举**的方式保证。但是，因为参与者的状态其实都是维护在协调者这边的，所以即使有选举，但是选举出来的新协调者，未必就知道在此之前所有参与者的全部状态信息

**2PC 是一种尽量保证强一致性的分布式事务，因此它是同步阻塞的，而同步阻塞就导致长久的资源锁定问题，总体而言效率低，并且存在单点故障问题，在极端条件下存在数据不一致的风险**

![](https://gitee.com/liaoxinyiqiqi/my-blog-images/raw/master/img/java-thread-07-05.jpg)  
<center>AQS的管程模型示意图</center>  

